---
title: "Analysis of Kyiv Road Traffic Using Uber Movement Data"
description: "This analysis uses Uber Movement speed data to analyze traffic of Kyiv, Ukraine. By looking at the speed data, we are able to find traffic flow's bottlenecks, as well as see the impact of COVID-19-related measures on the city traffic"
slug: uber-movement-kyiv
author:
  - name: Taras Kaduk
    url: https://taraskaduk.com
date: 2020-10-12
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_depth: 2
bibliography: bibliography.bib
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r libs}
library(sf)
library(osmdata)
library(lubridate)
library(gganimate)
library(tidyverse)
library(extrafont)
```

```{r theme}
loadfonts()
theme_tk <- theme_minimal() +
  theme(plot.background = element_rect(fill="#F3F6F7",
                                       colour = "#F3F6F7"),
        panel.background = element_rect(fill="#F3F6F7",
                                        colour = "#F3F6F7"),
        text = element_text(family="Raleway"),
        plot.title = element_text(size=32, 
                                  family="Raleway"),
        plot.caption = element_text(size=14, 
                                    family="Raleway"),
        legend.title = element_text(family="Raleway"),
        legend.text = element_text(family="Raleway",
                                   size = 7),
        axis.text = element_text(family="Roboto Mono"),
        legend.position="bottom",
        plot.margin = unit(c(1,0,1,0), units = "cm")
        )
theme_set(theme_tk)
```

## Introduction

## Data, Materials, Methods
For this analysis, I used data provided by Uber Movement [@uber_technologies_inc_uber_2020]. Other data sources, such as [TomTom Historical Traffic Stats](https://www.tomtom.com/products/historical-traffic-stats/), on which more elaborate traffic studies are based [@tomtom_nv_helsinki_2020]. However, obtaining such data points are often associated with pay walls of "freemium" developer accounts, which is completely understandable, yet which at the same time complicates the progress of citizen data science. 

The benefit of working with Uber Movement data is its free availability for selected cities. The downside is in the limits of traffic data's availability: at the time of this writing in October 2020, some Uber Movement data is available for only 60 cities worldwide. For Kyiv, the city in question, it is also available only up through 2020-03-31.

### Initial Data
Obtaining the data can be done via [NPM Uber Movement Data Toolkit](https://www.npmjs.com/package/movement-data-toolkit), or directly from https://movement.uber.com/ as `.csv` files.

The streets data contains multiple road segments each several meters long and identified by OSM IDs: way ID, start node ID, end node ID. An additional step was taken to only include road segment within administrative city boundaries.

```{r streets-import}
# Kyiv geometry -----------------------------------------------------------

place <- "Kyiv Ukraine"

boundary <- opq(place) %>%
  add_osm_feature(key = "boundary", 
                  value = c("administrative")) %>%
  osmdata_sf() %>% 
  osmdata::unname_osmdata_sf() %>% 
  .$osm_multipolygons %>% 
  filter(osm_id == 421866) %>% 
  dplyr::select()

water_osm <- opq(place) %>%
  add_osm_feature(key = "natural", value = "water") %>%
  osmdata_sf() %>% 
  unname_osmdata_sf()

river_osm <- opq(place) %>%
  add_osm_feature(key = "waterway", value = c("river", "riverbank")) %>%
  osmdata_sf() %>% 
  unname_osmdata_sf()

water <- c(water_osm, river_osm) %>% 
  .$osm_multipolygons %>% 
  select(osm_id, name) %>% 
  mutate(area = st_area(.)) %>% 
  filter(area >= quantile(area, probs = 0.75)) %>% 
  st_buffer(0) %>% 
  st_intersection(boundary)

# Streets -----------------------------------------------------------

# This the CLI command for pulling geometries; 
#   $ mdt create-geometry-file kyiv 2020 --output="kyiv.geojson"
streets_import <- st_read("data/kyiv.geojson") %>% 
  # See https://community.rstudio.com/t/why-does-st-transform-re-set-coordinates-to-0-0/82430
  # for why setting CRS to 4326
  st_set_crs(4326)

streets_filtered <- streets_import %>% 
  # filter(osmhighway %in% c("primary", "primary_link", 
  #                          "secondary", "secondary_link",
  #                          "tetriary", "tertiary_link")) %>% 
  st_intersection(boundary)

streets <- streets_filtered %>% 
  rename(osm_start_node_id = osmstartnodeid,
         osm_end_node_id = osmendnodeid,
         osm_way_id = osmwayid)

segments <- streets %>% 
  select(osm_way_id, osm_start_node_id, osm_end_node_id)
st_geometry(segments) <- NULL
segments <- segments %>% 
  distinct(.keep_all = TRUE) %>% 
  mutate(index = row_number())

streets <- streets %>% 
  inner_join(segments, by=c("osm_way_id", "osm_start_node_id", "osm_end_node_id"))

streets_lengths <- streets %>% 
  select(index) %>% 
  mutate(length = st_length(.) %>% as.numeric(),
         length = length/1000)
st_geometry(streets_lengths) <- NULL

```

As far as speed data, Uber Movement can provide daily data on an "hour" grain level for the above mentioned road segments. Variables provided are mean speed and speed standard deviation. To summarize, each observation includes mean speed and standard deviation for a particular short road segment on a specific hour of a specific day.


```{r speeds}
# Speed data --------------------------------------------------------------

speeds_import <- readRDS("data/kyiv_speeds_2020.RDS")

speeds <- speeds_import %>% 
  inner_join(segments, by = c("osm_way_id", "osm_start_node_id", "osm_end_node_id")) %>% 
  inner_join(streets_lengths, by = "index") %>% 
  mutate(time = length/speed_kph_mean,
         timestamp = with_tz(utc_timestamp, tzone = "Europe/Kiev")) %>% 
  select(-c(utc_timestamp,osm_way_id, osm_start_node_id, osm_end_node_id))
  
mean_speed <- mean(speeds$speed_kph_mean)

covid <- as.Date("2020-03-12")

```



### Data Transformation
To get the final metric of traffic delay (expressed as a %), a series of data transformation steps was taken:

- each segment's length was obtained from the geometry data;
- given each segment's length and mean speed, average travel was obtained;
- for every segment, using daytime weekend data^[Nighttime data was avoided due to an increased probability of excessive speeding, which would skew the data. Instead, weekend daytime speeds were analyzed to establish the benchmark], maximum speed was obtained for every Saturday and Sunday, and the mean of these maximum weekend daytime speeds was established as segment's benchmark speed.
- with maximum speeds available, "best time" was calculated for every observation, and the difference between actual travel time and "best time" constituted a time delay. 
- in every subsequent grouping and aggregation, delays and "best" times would be summed up, and diving total delay time by total "best time" produced the final metric.

```{r speeds-transform}
speeds_max <- speeds %>% 
  filter(wday(timestamp) %in% c(1,7) & 
           hour(timestamp) >= 6 &
           hour(timestamp) <= 22
           ) %>% 
  mutate(date = date(timestamp)) %>% 
  group_by(index, date) %>% 
  summarise(max_speed = max(speed_kph_mean)) %>% 
  ungroup() %>% 
  group_by(index) %>% 
  summarise(max_speed = mean(max_speed) %>% round(2)) %>% 
  ungroup()

speeds_delay <- speeds %>% 
  inner_join(speeds_max, by = "index") %>% 
  mutate(best_time = if_else(max_speed < speed_kph_mean, time, length/max_speed),
         delay = time - best_time)
```


## Results

### Key patterns

```{r}
speeds_bydayhour <- speeds_delay %>% 
  mutate(hour = hour(timestamp),
         date = date(timestamp)) %>% 
  group_by(date, hour) %>% 
  summarise(distance = sum(length),
            time = sum(time),
            best_time = sum(best_time),
            delay = sum(delay),
            speed_mean = mean(speed_kph_mean)) %>% 
  ungroup() %>% 
  mutate(speed = distance / time,
         delay_pct = delay / best_time)


ggplot(speeds_bydayhour, aes(x=date, y=hour, fill=delay_pct)) +
  geom_tile()+
  geom_vline(xintercept=covid,
             linetype = 3) +
  annotate("label", x = covid, y = 25, 
           label = "COVID-19 quarantine",
           label.size=NA,
           fill="#F3F6F7",
           family="Raleway") +
  scale_fill_viridis_c(
        labels = scales::percent_format(accuracy = 1),
        breaks = c(0.25,0.5,1,2.5),
        na.value = "grey50",
        guide = "coloursteps",
        option = "magma",
        direction = -1) +
  scale_y_continuous(breaks = c(0,8,18,23), 
                     labels = c("12 AM", "8 AM", "6 PM", "11 PM")) +
  scale_x_date(date_labels = "%b %d",
               date_breaks = "1 month"
               ) +
  theme(axis.title = element_blank(),
        legend.position="right",
        legend.text = element_text(size = 10),
        panel.grid.minor = element_blank()) +
  coord_equal() +
  labs(title = paste0("Kyiv city traffic delay by hour of the day"),
           caption = "taraskaduk.com | @taraskaduk",
           fill = "Traffic Delay, %")
```



## Discussion